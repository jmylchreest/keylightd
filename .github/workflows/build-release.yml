name: Build Release

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      release:
        description: "Create a release (will create and push a version tag)"
        required: false
        default: false
        type: boolean

jobs:
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      is_snapshot: ${{ steps.version.outputs.IS_SNAPSHOT }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Release build from tag
            VERSION="${GITHUB_REF#refs/tags/v}"
            IS_SNAPSHOT="false"
          else
            # Get last tag and calculate next version
            LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            LAST_VERSION="${LAST_TAG#v}"

            # Increment patch version
            IFS='.' read -r MAJOR MINOR PATCH <<< "$LAST_VERSION"
            NEXT_PATCH=$((PATCH + 1))
            NEXT_VERSION="${MAJOR}.${MINOR}.${NEXT_PATCH}"

            if [[ "${{ github.event.inputs.release }}" == "true" ]]; then
              # Manual release requested
              VERSION="${NEXT_VERSION}"
              IS_SNAPSHOT="false"
            else
              # Snapshot build from main branch or workflow_dispatch
              SHORT_SHA=$(git rev-parse --short HEAD)
              VERSION="${NEXT_VERSION}-${SHORT_SHA}-SNAPSHOT"
              IS_SNAPSHOT="true"
            fi
          fi

          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "IS_SNAPSHOT=${IS_SNAPSHOT}" >> $GITHUB_OUTPUT
          echo "Determined version: ${VERSION} (snapshot: ${IS_SNAPSHOT})"

      - name: Create and push release tag
        if: github.event.inputs.release == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ steps.version.outputs.VERSION }}" -m "Release v${{ steps.version.outputs.VERSION }}"
          git push origin "v${{ steps.version.outputs.VERSION }}"

  build-binaries:
    name: Build binaries (${{ matrix.goos }}/${{ matrix.goarch }})
    runs-on: ${{ matrix.os }}
    needs: prepare
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            os: ubuntu-latest
          - goos: linux
            goarch: arm64
            os: ubuntu-24.04-arm
          - goos: darwin
            goarch: amd64
            os: macos-latest
          - goos: darwin
            goarch: arm64
            os: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: stable
          cache: true

      - name: Build keylightd
        env:
          CGO_ENABLED: 0
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          go build -ldflags "-s -w -X main.version=${{ needs.prepare.outputs.version }} -X main.commit=${{ github.sha }} -X main.buildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)" -o keylightd ./cmd/keylightd

      - name: Build keylightctl
        env:
          CGO_ENABLED: 0
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          go build -ldflags "-s -w -X main.version=${{ needs.prepare.outputs.version }} -X main.commit=${{ github.sha }} -X main.buildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)" -o keylightctl ./cmd/keylightctl

      - name: Create archive
        run: |
          mkdir -p dist
          tar -czvf dist/keylightd_${{ needs.prepare.outputs.version }}_${{ matrix.goos }}_${{ matrix.goarch }}.tar.gz \
            keylightd \
            keylightctl \
            LICENSE \
            README.md \
            contrib/systemd/keylightd.service

      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: keylightd_${{ needs.prepare.outputs.version }}_${{ matrix.goos }}_${{ matrix.goarch }}
          path: dist/*.tar.gz
          retention-days: 1

  build-keylightd-tray:
    name: Build keylightd-tray (${{ matrix.goos }}/${{ matrix.goarch }})
    runs-on: ${{ matrix.os }}
    needs: prepare
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            os: ubuntu-latest
          - goos: linux
            goarch: arm64
            os: ubuntu-24.04-arm
          - goos: darwin
            goarch: universal
            os: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: stable
          cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install Linux dependencies
        if: matrix.goos == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev

      - name: Build keylightd-tray (Linux)
        if: matrix.goos == 'linux'
        working-directory: contrib/keylightd-tray
        run: |
          wails build -tags webkit2_41,desktop -ldflags "-s -w -X main.version=${{ needs.prepare.outputs.version }} -X main.commit=${{ github.sha }} -X main.buildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)"

      - name: Build keylightd-tray (macOS)
        if: matrix.goos == 'darwin'
        working-directory: contrib/keylightd-tray
        run: |
          wails build -platform darwin/universal -ldflags "-s -w -X main.version=${{ needs.prepare.outputs.version }} -X main.commit=${{ github.sha }} -X main.buildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)"

      - name: Create archive (Linux)
        if: matrix.goos == 'linux'
        run: |
          mkdir -p dist
          tar -czvf dist/keylightd-tray_v${{ needs.prepare.outputs.version }}_${{ matrix.goos }}_${{ matrix.goarch }}.tar.gz \
            -C contrib/keylightd-tray/build/bin keylightd-tray \
            -C ${{ github.workspace }} LICENSE README.md

      - name: Create archive (macOS)
        if: matrix.goos == 'darwin'
        run: |
          mkdir -p dist
          tar -czvf dist/keylightd-tray_v${{ needs.prepare.outputs.version }}_${{ matrix.goos }}_${{ matrix.goarch }}.tar.gz \
            -C contrib/keylightd-tray/build/bin keylightd-tray.app \
            -C ${{ github.workspace }} LICENSE README.md

      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: keylightd-tray_v${{ needs.prepare.outputs.version }}_${{ matrix.goos }}_${{ matrix.goarch }}
          path: dist/*.tar.gz
          retention-days: 1

  build-gnome-extension:
    name: Build GNOME extension
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y make zip

      - name: Build extension
        run: |
          cd contrib/gnome-extension
          make zip

      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: keylightd-gnome-extension_${{ needs.prepare.outputs.version }}
          path: dist/gnome-extension/*.zip
          retention-days: 1

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs:
      [prepare, build-binaries, build-keylightd-tray, build-gnome-extension]
    outputs:
      version: ${{ needs.prepare.outputs.version }}
      is_snapshot: ${{ needs.prepare.outputs.is_snapshot }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts
          merge-multiple: false

      - name: Prepare release assets
        run: |
          mkdir -p release

          # Move all tarballs to release directory
          find artifacts -name "*.tar.gz" -exec mv {} release/ \;

          # Move GNOME extension
          find artifacts -name "*.zip" -exec cp {} release/keylightd-control@jmylchreest.github.io.shell-extension.zip \;

          # List all release assets
          echo "=== Release assets ==="
          ls -la release/

      - name: Generate SBOMs
        run: |
          # Install syft
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

          # Generate SBOM for each tarball
          cd release
          for tarball in *.tar.gz; do
            name="${tarball%.tar.gz}"
            syft "$tarball" -o spdx-json > "${name}_sbom.spdx.json"
            echo "Generated SBOM for $tarball"
          done

          echo "=== Generated SBOMs ==="
          ls -la *_sbom.spdx.json

      - name: Generate checksums
        run: |
          cd release
          sha256sum *.tar.gz *.zip *.spdx.json > keylightd_${{ needs.prepare.outputs.version }}_checksums.txt
          echo "=== Checksums ==="
          cat keylightd_${{ needs.prepare.outputs.version }}_checksums.txt

      - name: Generate changelog
        id: changelog
        run: |
          if [[ "${{ needs.prepare.outputs.is_snapshot }}" == "true" ]]; then
            echo "Snapshot build from commit ${{ github.sha }}" > changelog.txt
            echo "" >> changelog.txt
            echo "Commit: $(git log -1 --pretty=%B)" >> changelog.txt
          else
            # Get previous tag
            PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

            if [ -n "$PREV_TAG" ]; then
              echo "## Changelog" > changelog.txt
              echo "" >> changelog.txt
              # Filter out docs, test, ci commits and merge commits
              git log --pretty=format:"* %h %s" $PREV_TAG..${{ github.ref_name }} | \
                grep -v "^* [a-f0-9]* docs:" | \
                grep -v "^* [a-f0-9]* test:" | \
                grep -v "^* [a-f0-9]* ci:" | \
                grep -v "^* [a-f0-9]* Merge pull request" | \
                grep -v "^* [a-f0-9]* Merge branch" >> changelog.txt || echo "* No notable changes" >> changelog.txt
            else
              echo "* Initial release" > changelog.txt
            fi
          fi

          echo "=== Changelog ==="
          cat changelog.txt

      - name: Clean up old snapshots
        if: needs.prepare.outputs.is_snapshot == 'true'
        run: |
          echo "Cleaning up old snapshot releases (keeping 5 most recent)..."

          # Get all snapshot releases sorted by creation date (oldest first)
          SNAPSHOT_RELEASES=$(gh release list --limit 100 --json tagName,isPrerelease,createdAt \
            --jq '[.[] | select(.isPrerelease == true and (.tagName | contains("SNAPSHOT")))] | sort_by(.createdAt) | .[].tagName')

          # Count total snapshots
          TOTAL=$(echo "$SNAPSHOT_RELEASES" | grep -c . || echo 0)
          echo "Found $TOTAL snapshot releases"

          # Calculate how many to delete (keep 4, since we're about to create 1 more = 5 total)
          TO_DELETE=$((TOTAL - 4))

          if [ "$TO_DELETE" -gt 0 ]; then
            echo "Deleting $TO_DELETE old snapshot releases..."
            echo "$SNAPSHOT_RELEASES" | head -n "$TO_DELETE" | while read -r tag; do
              if [ -n "$tag" ]; then
                echo "Deleting release: $tag"
                gh release delete "$tag" --yes --cleanup-tag || true
              fi
            done
          else
            echo "No snapshot releases to delete"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ needs.prepare.outputs.is_snapshot == 'true' && format('Snapshot {0}', needs.prepare.outputs.version) || format('v{0}', needs.prepare.outputs.version) }}
          tag_name: ${{ needs.prepare.outputs.is_snapshot == 'true' && needs.prepare.outputs.version || github.ref_name }}
          body_path: changelog.txt
          files: release/*
          draft: false
          prerelease: ${{ needs.prepare.outputs.is_snapshot == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Save checksums for publishing jobs
        uses: actions/upload-artifact@v5
        with:
          name: keylightd_${{ needs.prepare.outputs.version }}_checksums
          path: release/keylightd_${{ needs.prepare.outputs.version }}_checksums.txt
          retention-days: 1

  publish-aur:
    name: Publish to AUR
    runs-on: ubuntu-latest
    needs: create-release
    if: needs.create-release.outputs.is_snapshot == 'false'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Download checksums
        uses: actions/download-artifact@v6
        with:
          name: keylightd_${{ needs.create-release.outputs.version }}_checksums
          path: checksums

      - name: Extract checksums
        id: checksums
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          CHECKSUM_FILE="checksums/keylightd_${VERSION}_checksums.txt"

          # Extract checksums for keylightd
          SHA256_LINUX_AMD64=$(grep "keylightd_${VERSION}_linux_amd64.tar.gz" "$CHECKSUM_FILE" | awk '{print $1}')
          SHA256_LINUX_ARM64=$(grep "keylightd_${VERSION}_linux_arm64.tar.gz" "$CHECKSUM_FILE" | awk '{print $1}')

          # Extract checksums for keylightd-tray
          SHA256_TRAY_AMD64=$(grep "keylightd-tray_v${VERSION}_linux_amd64.tar.gz" "$CHECKSUM_FILE" | awk '{print $1}')
          SHA256_TRAY_ARM64=$(grep "keylightd-tray_v${VERSION}_linux_arm64.tar.gz" "$CHECKSUM_FILE" | awk '{print $1}')

          # Extract SBOM checksums for keylightd
          SHA256_SBOM_AMD64=$(grep "keylightd_${VERSION}_linux_amd64_sbom.spdx.json" "$CHECKSUM_FILE" | awk '{print $1}')
          SHA256_SBOM_ARM64=$(grep "keylightd_${VERSION}_linux_arm64_sbom.spdx.json" "$CHECKSUM_FILE" | awk '{print $1}')

          # Extract SBOM checksums for keylightd-tray
          SHA256_SBOM_TRAY_AMD64=$(grep "keylightd-tray_v${VERSION}_linux_amd64_sbom.spdx.json" "$CHECKSUM_FILE" | awk '{print $1}')
          SHA256_SBOM_TRAY_ARM64=$(grep "keylightd-tray_v${VERSION}_linux_arm64_sbom.spdx.json" "$CHECKSUM_FILE" | awk '{print $1}')

          echo "SHA256_LINUX_AMD64=${SHA256_LINUX_AMD64}" >> $GITHUB_OUTPUT
          echo "SHA256_LINUX_ARM64=${SHA256_LINUX_ARM64}" >> $GITHUB_OUTPUT
          echo "SHA256_TRAY_AMD64=${SHA256_TRAY_AMD64}" >> $GITHUB_OUTPUT
          echo "SHA256_TRAY_ARM64=${SHA256_TRAY_ARM64}" >> $GITHUB_OUTPUT
          echo "SHA256_SBOM_AMD64=${SHA256_SBOM_AMD64}" >> $GITHUB_OUTPUT
          echo "SHA256_SBOM_ARM64=${SHA256_SBOM_ARM64}" >> $GITHUB_OUTPUT
          echo "SHA256_SBOM_TRAY_AMD64=${SHA256_SBOM_TRAY_AMD64}" >> $GITHUB_OUTPUT
          echo "SHA256_SBOM_TRAY_ARM64=${SHA256_SBOM_TRAY_ARM64}" >> $GITHUB_OUTPUT

          echo "=== Extracted checksums ==="
          cat "$CHECKSUM_FILE"

      - name: Generate keylightd-bin PKGBUILD
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          mkdir -p aur/keylightd-bin

          sed -e "s/{{VERSION}}/${VERSION}/g" \
              -e "s/{{AUR_MAINTAINER}}/${{ secrets.AUR_MAINTAINER }}/g" \
              -e "s/{{SHA256_AMD64}}/${{ steps.checksums.outputs.SHA256_LINUX_AMD64 }}/g" \
              -e "s/{{SHA256_ARM64}}/${{ steps.checksums.outputs.SHA256_LINUX_ARM64 }}/g" \
              -e "s/{{SHA256_SBOM_AMD64}}/${{ steps.checksums.outputs.SHA256_SBOM_AMD64 }}/g" \
              -e "s/{{SHA256_SBOM_ARM64}}/${{ steps.checksums.outputs.SHA256_SBOM_ARM64 }}/g" \
              contrib/aur/keylightd-bin/PKGBUILD.template > aur/keylightd-bin/PKGBUILD

          echo "=== Generated keylightd-bin PKGBUILD ==="
          cat aur/keylightd-bin/PKGBUILD

      - name: Generate keylightd-tray-bin PKGBUILD
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          mkdir -p aur/keylightd-tray-bin

          sed -e "s/{{VERSION}}/${VERSION}/g" \
              -e "s/{{AUR_MAINTAINER}}/${{ secrets.AUR_MAINTAINER }}/g" \
              -e "s/{{SHA256_AMD64}}/${{ steps.checksums.outputs.SHA256_TRAY_AMD64 }}/g" \
              -e "s/{{SHA256_ARM64}}/${{ steps.checksums.outputs.SHA256_TRAY_ARM64 }}/g" \
              -e "s/{{SHA256_SBOM_AMD64}}/${{ steps.checksums.outputs.SHA256_SBOM_TRAY_AMD64 }}/g" \
              -e "s/{{SHA256_SBOM_ARM64}}/${{ steps.checksums.outputs.SHA256_SBOM_TRAY_ARM64 }}/g" \
              contrib/aur/keylightd-tray-bin/PKGBUILD.template > aur/keylightd-tray-bin/PKGBUILD

          echo "=== Generated keylightd-tray-bin PKGBUILD ==="
          cat aur/keylightd-tray-bin/PKGBUILD

      - name: Publish keylightd-bin to AUR
        uses: KSXGitHub/github-actions-deploy-aur@v4.1.1
        with:
          pkgname: keylightd-bin
          pkgbuild: aur/keylightd-bin/PKGBUILD
          commit_username: goreleaserbot
          commit_email: bot@goreleaser.com
          ssh_private_key: ${{ secrets.AUR_KEY }}
          commit_message: "Update to ${{ needs.create-release.outputs.version }}"

      - name: Publish keylightd-tray-bin to AUR
        uses: KSXGitHub/github-actions-deploy-aur@v4.1.1
        with:
          pkgname: keylightd-tray-bin
          pkgbuild: aur/keylightd-tray-bin/PKGBUILD
          commit_username: goreleaserbot
          commit_email: bot@goreleaser.com
          ssh_private_key: ${{ secrets.AUR_KEY }}
          commit_message: "Update to ${{ needs.create-release.outputs.version }}"

  publish-homebrew:
    name: Publish to Homebrew
    runs-on: ubuntu-latest
    needs: create-release
    if: needs.create-release.outputs.is_snapshot == 'false'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Download checksums
        uses: actions/download-artifact@v6
        with:
          name: keylightd_${{ needs.create-release.outputs.version }}_checksums
          path: checksums

      - name: Extract checksums
        id: checksums
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          CHECKSUM_FILE="checksums/keylightd_${VERSION}_checksums.txt"

          # keylightd checksums
          SHA256_DARWIN_AMD64=$(grep "keylightd_${VERSION}_darwin_amd64.tar.gz" "$CHECKSUM_FILE" | awk '{print $1}')
          SHA256_DARWIN_ARM64=$(grep "keylightd_${VERSION}_darwin_arm64.tar.gz" "$CHECKSUM_FILE" | awk '{print $1}')
          SHA256_LINUX_AMD64=$(grep "keylightd_${VERSION}_linux_amd64.tar.gz" "$CHECKSUM_FILE" | awk '{print $1}')
          SHA256_LINUX_ARM64=$(grep "keylightd_${VERSION}_linux_arm64.tar.gz" "$CHECKSUM_FILE" | awk '{print $1}')

          # keylightd-tray checksums
          SHA256_TRAY_DARWIN_UNIVERSAL=$(grep "keylightd-tray_v${VERSION}_darwin_universal.tar.gz" "$CHECKSUM_FILE" | awk '{print $1}')
          SHA256_TRAY_LINUX_AMD64=$(grep "keylightd-tray_v${VERSION}_linux_amd64.tar.gz" "$CHECKSUM_FILE" | awk '{print $1}')
          SHA256_TRAY_LINUX_ARM64=$(grep "keylightd-tray_v${VERSION}_linux_arm64.tar.gz" "$CHECKSUM_FILE" | awk '{print $1}')

          # SBOM checksums for keylightd
          SHA256_SBOM_DARWIN_AMD64=$(grep "keylightd_${VERSION}_darwin_amd64_sbom.spdx.json" "$CHECKSUM_FILE" | awk '{print $1}')
          SHA256_SBOM_DARWIN_ARM64=$(grep "keylightd_${VERSION}_darwin_arm64_sbom.spdx.json" "$CHECKSUM_FILE" | awk '{print $1}')
          SHA256_SBOM_LINUX_AMD64=$(grep "keylightd_${VERSION}_linux_amd64_sbom.spdx.json" "$CHECKSUM_FILE" | awk '{print $1}')
          SHA256_SBOM_LINUX_ARM64=$(grep "keylightd_${VERSION}_linux_arm64_sbom.spdx.json" "$CHECKSUM_FILE" | awk '{print $1}')

          # SBOM checksums for keylightd-tray
          SHA256_SBOM_TRAY_DARWIN_UNIVERSAL=$(grep "keylightd-tray_v${VERSION}_darwin_universal_sbom.spdx.json" "$CHECKSUM_FILE" | awk '{print $1}')
          SHA256_SBOM_TRAY_LINUX_AMD64=$(grep "keylightd-tray_v${VERSION}_linux_amd64_sbom.spdx.json" "$CHECKSUM_FILE" | awk '{print $1}')
          SHA256_SBOM_TRAY_LINUX_ARM64=$(grep "keylightd-tray_v${VERSION}_linux_arm64_sbom.spdx.json" "$CHECKSUM_FILE" | awk '{print $1}')

          echo "SHA256_DARWIN_AMD64=${SHA256_DARWIN_AMD64}" >> $GITHUB_OUTPUT
          echo "SHA256_DARWIN_ARM64=${SHA256_DARWIN_ARM64}" >> $GITHUB_OUTPUT
          echo "SHA256_LINUX_AMD64=${SHA256_LINUX_AMD64}" >> $GITHUB_OUTPUT
          echo "SHA256_LINUX_ARM64=${SHA256_LINUX_ARM64}" >> $GITHUB_OUTPUT
          echo "SHA256_TRAY_DARWIN_UNIVERSAL=${SHA256_TRAY_DARWIN_UNIVERSAL}" >> $GITHUB_OUTPUT
          echo "SHA256_TRAY_LINUX_AMD64=${SHA256_TRAY_LINUX_AMD64}" >> $GITHUB_OUTPUT
          echo "SHA256_TRAY_LINUX_ARM64=${SHA256_TRAY_LINUX_ARM64}" >> $GITHUB_OUTPUT
          echo "SHA256_SBOM_DARWIN_AMD64=${SHA256_SBOM_DARWIN_AMD64}" >> $GITHUB_OUTPUT
          echo "SHA256_SBOM_DARWIN_ARM64=${SHA256_SBOM_DARWIN_ARM64}" >> $GITHUB_OUTPUT
          echo "SHA256_SBOM_LINUX_AMD64=${SHA256_SBOM_LINUX_AMD64}" >> $GITHUB_OUTPUT
          echo "SHA256_SBOM_LINUX_ARM64=${SHA256_SBOM_LINUX_ARM64}" >> $GITHUB_OUTPUT
          echo "SHA256_SBOM_TRAY_DARWIN_UNIVERSAL=${SHA256_SBOM_TRAY_DARWIN_UNIVERSAL}" >> $GITHUB_OUTPUT
          echo "SHA256_SBOM_TRAY_LINUX_AMD64=${SHA256_SBOM_TRAY_LINUX_AMD64}" >> $GITHUB_OUTPUT
          echo "SHA256_SBOM_TRAY_LINUX_ARM64=${SHA256_SBOM_TRAY_LINUX_ARM64}" >> $GITHUB_OUTPUT

      - name: Generate keylightd formula
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"

          sed -e "s/{{VERSION}}/${VERSION}/g" \
              -e "s/{{SHA256_DARWIN_AMD64}}/${{ steps.checksums.outputs.SHA256_DARWIN_AMD64 }}/g" \
              -e "s/{{SHA256_DARWIN_ARM64}}/${{ steps.checksums.outputs.SHA256_DARWIN_ARM64 }}/g" \
              -e "s/{{SHA256_LINUX_AMD64}}/${{ steps.checksums.outputs.SHA256_LINUX_AMD64 }}/g" \
              -e "s/{{SHA256_LINUX_ARM64}}/${{ steps.checksums.outputs.SHA256_LINUX_ARM64 }}/g" \
              -e "s/{{SHA256_SBOM_DARWIN_AMD64}}/${{ steps.checksums.outputs.SHA256_SBOM_DARWIN_AMD64 }}/g" \
              -e "s/{{SHA256_SBOM_DARWIN_ARM64}}/${{ steps.checksums.outputs.SHA256_SBOM_DARWIN_ARM64 }}/g" \
              -e "s/{{SHA256_SBOM_LINUX_AMD64}}/${{ steps.checksums.outputs.SHA256_SBOM_LINUX_AMD64 }}/g" \
              -e "s/{{SHA256_SBOM_LINUX_ARM64}}/${{ steps.checksums.outputs.SHA256_SBOM_LINUX_ARM64 }}/g" \
              contrib/homebrew/keylightd.rb.template > keylightd.rb

          echo "=== Generated keylightd formula ==="
          cat keylightd.rb

      - name: Generate keylightd-tray formula
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"

          sed -e "s/{{VERSION}}/${VERSION}/g" \
              -e "s/{{SHA256_DARWIN_UNIVERSAL}}/${{ steps.checksums.outputs.SHA256_TRAY_DARWIN_UNIVERSAL }}/g" \
              -e "s/{{SHA256_LINUX_AMD64}}/${{ steps.checksums.outputs.SHA256_TRAY_LINUX_AMD64 }}/g" \
              -e "s/{{SHA256_LINUX_ARM64}}/${{ steps.checksums.outputs.SHA256_TRAY_LINUX_ARM64 }}/g" \
              -e "s/{{SHA256_SBOM_DARWIN_UNIVERSAL}}/${{ steps.checksums.outputs.SHA256_SBOM_TRAY_DARWIN_UNIVERSAL }}/g" \
              -e "s/{{SHA256_SBOM_LINUX_AMD64}}/${{ steps.checksums.outputs.SHA256_SBOM_TRAY_LINUX_AMD64 }}/g" \
              -e "s/{{SHA256_SBOM_LINUX_ARM64}}/${{ steps.checksums.outputs.SHA256_SBOM_TRAY_LINUX_ARM64 }}/g" \
              contrib/homebrew/keylightd-tray.rb.template > keylightd-tray.rb

          echo "=== Generated keylightd-tray formula ==="
          cat keylightd-tray.rb

      - name: Push to Homebrew tap
        run: |
          git clone https://x-access-token:${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}@github.com/jmylchreest/homebrew-keylightd.git tap

          mkdir -p tap/Formula
          cp keylightd.rb tap/Formula/keylightd.rb
          cp keylightd-tray.rb tap/Formula/keylightd-tray.rb

          cd tap
          git config user.name "goreleaserbot"
          git config user.email "bot@goreleaser.com"
          git add Formula/keylightd.rb Formula/keylightd-tray.rb
          git commit -m "Update keylightd to ${{ needs.create-release.outputs.version }}"
          git push

  publish-ego:
    name: Publish to EGO
    runs-on: ubuntu-latest
    needs: create-release
    if: needs.create-release.outputs.is_snapshot == 'false'
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Check if GNOME extension changed
        id: check-changes
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found, will publish"
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            # Check if any files in the extension directory changed
            CHANGED=$(git diff --name-only "$PREV_TAG" HEAD -- contrib/gnome-extension/keylightd-control@jmylchreest.github.io/)

            if [ -n "$CHANGED" ]; then
              echo "GNOME extension files changed:"
              echo "$CHANGED"
              echo "changed=true" >> $GITHUB_OUTPUT
            else
              echo "No changes to GNOME extension since $PREV_TAG"
              echo "changed=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Upload to EGO
        if: steps.check-changes.outputs.changed == 'true'
        uses: murar8/gnome-extensions-action@0.1.0
        with:
          source-dir: contrib/gnome-extension/keylightd-control@jmylchreest.github.io
          username: ${{ secrets.EGO_USERNAME }}
          password: ${{ secrets.EGO_PASSWORD }}
          accept-tos: true
