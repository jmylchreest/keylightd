# Keylightd Control GNOME Extension

This directory contains a GNOME Shell extension for controlling Elgato Keylights via the keylightd HTTP API.

## Features
- Integrates with GNOME quick settings
- Control individual lights and groups
- Configure API endpoint and authentication key via UI
- About page showing version and commit information
- Automatic version embedding via GitHub workflows
- Follows GNOME extension best practices for structure and packaging

## Directory Structure

```
contrib/gnome-extension/
  Makefile
  README.md
  update-version-info.sh
  tests/
    run-tests.sh
    check-imports.sh
    test-version-info.sh
    test-build-integration.sh
  keylightd-control@jmylchreest.github.io/
    extension.js
    stylesheet.css
    metadata.json
    version-info.json
    preferences/
      generalPage.js
      groupsPage.js
      lightsPage.js
      uiPage.js
      aboutPage.js
    prefs.js
    schemas/
      org.gnome.shell.extensions.keylightd-control.gschema.xml
    icons/
      hicolor/
        scalable/
          actions/
            help-about-symbolic.svg
            (and other icon files...)
```

## Development & Packaging

1. **Update version information (optional - done automatically by Makefile):**
   ```sh
   make version-info
   ```
   Or run the script directly:
   ```sh
   ./update-version-info.sh
   ```

2. **Build schemas:**
   ```sh
   make build
   ```
   This automatically generates version info, runs tests, and compiles schemas.

3. **Package the extension:**
   ```sh
   make pack
   ```
   This uses `gnome-extensions pack` and outputs a zip in `../../dist/gnome-extension/`.

4. **Create zip (alternative to pack):**
   ```sh
   make zip
   ```

5. **Test the implementation:**
   ```sh
   make test
   ```

6. **Run tests:**
   ```sh
   make test
   ```
   Or run specific test types:
   ```sh
   cd tests
   ./run-tests.sh unit        # Fast validation tests (default)
   ./run-tests.sh integration # Full build and packaging tests
   ./run-tests.sh all         # All tests
   ```

## Installation & Testing

1. **Install the packed extension:**
   ```sh
   gnome-extensions install --force dist/gnome-extension/keylightd-control@jmylchreest.github.io.shell-extension.zip
   ```
   Or copy the folder to your local extensions directory:
   ```sh
   cp -r contrib/gnome-extension/keylightd-control@jmylchreest.github.io ~/.local/share/gnome-shell/extensions/
   ```
2. **Compile schemas (if not using the zip):**
   ```sh
   glib-compile-schemas ~/.local/share/gnome-shell/extensions/keylightd-control@jmylchreest.github.io/schemas
   ```
3. **Enable the extension:**
   ```sh
   gnome-extensions enable keylightd-control@jmylchreest.github.io
   ```
4. **Reload GNOME Shell:** (Alt+F2, type 'r', press Enter)
5. **Configure:** Click the icon in the quick settings menu and set the API endpoint and key.

> **Note:** If the API key is not set, the extension will not attempt to interact with the API and will only show the configuration UI.

## Icon
- The extension icon is located at `icons/hicolor/scalable/actions/keylight-symbolic.svg` inside the extension directory, following GNOME icon theme conventions.

## Preferences
- The preferences dialog is implemented in `prefs.js` with individual pages in the `preferences/` directory
- Includes tabs for General, Groups, Lights, UI, and About
- The About tab shows version and commit information from `version-info.json`
- Can be accessed from the extension menu or via the GNOME Extensions app

## Version Information

The extension includes automatic version embedding via the build system:

- `version-info.json` contains project name, description, version, and commit hash
- This file is automatically generated by the Makefile calling `update-version-info.sh`
- The About preferences page displays this information to users
- Version info is extracted from git tags, branch names, or environment variables
- The `build` target depends on `version-info`, ensuring it's always up-to-date

## Import Best Practices

The extension follows GNOME Shell best practices for imports:

- **Shell Process Files** (extension.js, ui/, controllers/, managers/, utils.js):
  - Should NOT import `Gtk` or `Gdk`
  - Use `St` (Shell Toolkit) for UI components
  - Use `Gio`, `GLib`, `GObject`, etc. as needed

- **Preferences Files** (prefs.js, preferences/):
  - CAN import `Gtk`, `Gdk`, and `Adw` for preferences UI
  - Run in a separate GTK process, not the Shell

Use `make test` or `cd tests && ./run-tests.sh` to verify all imports follow these rules.

## Contributing
- Please follow the structure and conventions in this repository. PRs are welcome!
- The version info system automatically handles version embedding via Makefile dependencies
- The `update-version-info.sh` script handles version detection and JSON generation
- Run `make test` to ensure proper import usage and validate extension before submitting PRs

## Testing

### Test Types

The extension includes a comprehensive test suite with different test types:

1. **Unit Tests** (fast validation):
   ```sh
   make test
   # or
   cd tests && ./run-tests.sh unit
   ```
   - Import validation (Gtk/Gdk usage rules)
   - File structure validation
   - Configuration validation

2. **Integration Tests** (full build cycle):
   ```sh
   cd tests && ./run-tests.sh integration
   ```
   - Complete build and packaging workflow
   - Version info generation with different environments
   - ZIP file validation

3. **All Tests**:
   ```sh
   cd tests && ./run-tests.sh all
   ```

### Build Integration

Tests are automatically run as part of the build process:
- `make build` → runs `make test` → compiles schemas
- `make pack` → runs full build including tests
- `make zip` → runs full build including tests

### CI Integration

Tests work seamlessly with GitHub Actions:
- Unit tests validate code structure and imports
- Integration tests verify complete build workflow
- Environment variables are properly handled during CI builds

## Debugging

### Testing in a Nested Wayland Session (Recommended)

Running GNOME Shell in a nested Wayland session allows you to test and debug your extension without affecting your main desktop session.

1. **Start a nested GNOME Shell session:**
   ```sh
   dbus-run-session -- gnome-shell --nested --wayland
   ```
   This will open a new GNOME Shell window inside your current session.

2. **Install and enable your extension inside the nested session:**
   - Open a terminal inside the nested session (e.g., with `Ctrl+Alt+T` or from the app grid).
   - Install the extension as described above.
   - Use `gnome-extensions` commands inside the nested session to enable/disable and debug.

3. **View logs for debugging:**
   - Run `journalctl -f /usr/bin/gnome-shell` in a terminal to see GNOME Shell logs in real time.
   - Use `gnome-extensions info keylightd-control@jmylchreest.github.io` for extension status.

### Quick Reload (X11 only)
- On X11, you can reload GNOME Shell with `Alt+F2`, type `r`, and press Enter.
- On Wayland, you must log out and back in, or use a nested session as above.

### General Tips
- Use the [Looking Glass](https://wiki.gnome.org/Projects/GnomeShell/LookingGlass) debugger (`lg` in Alt+F2) for live JS console and object inspection.
- Use `console.log()` and `console.error()` in your JS code for debugging output.
- Always test with both the preferences dialog and the quick settings menu. 